# Enhancement: YAML Configuration Support for bin/export-bundler-config

## Overview

Enhance `bin/export-bundler-config` to support YAML configuration files for managing complex build configurations. This allows users to define and version control their various build scenarios (dev, production, cypress, etc.) with different environment variables and bundler settings.

## Motivation

Many applications use complex build commands with multiple environment variables and bundler-specific arguments. For example:

```bash
NODE_OPTIONS="--max-old-space-size=4096" NODE_ENV=development RAILS_ENV=development webpack --env env=dev --config webpack.config.ts
BABEL_ENV=test RAILS_ENV=test NODE_ENV=test webpack --env env=dev --config webpack.config.ts
NODE_ENV=production RAILS_ENV=production webpack --env env=serverBundleProd --config webpack.config.ts
```

Currently, users must:

- Remember or document these complex commands
- Manually specify all environment variables and flags each time
- Cannot easily switch between webpack and rspack for testing

This enhancement allows users to:

- Define build configurations in a version-controlled YAML file
- Easily switch between webpack and rspack with a simple flag
- Export configs for any defined build scenario
- Self-document their build process

## YAML Configuration Schema

### File Structure

**Default filename:** `.bundler-config.yml` (configurable via `--config-file=<path>`)

```yaml
# Bundler Build Configurations
# Generated by: bin/export-bundler-config --init

# Default bundler for all builds (can be overridden with --webpack or --rspack)
default_bundler: webpack # or rspack

builds:
  # Development: Both client and server bundles
  dev:
    description: Build admin and consumer bundles for dev env
    environment:
      NODE_OPTIONS: "--max-old-space-size=4096"
      NODE_ENV: development
      RAILS_ENV: development
    bundler_env:
      env: dev
    outputs:
      - client
      - server
    # config: webpack.config.ts  # Optional: auto-detected

  # Development: Server only
  dev-server:
    description: Build server bundle for dev env
    environment:
      NODE_ENV: development
      RAILS_ENV: development
    bundler_env:
      env: serverBundleDev
    outputs:
      - server

  # Cypress development
  cypress-dev:
    description: Build for Cypress development
    environment:
      NODE_OPTIONS: "--max-old-space-size=4096"
      BABEL_ENV: test
      RAILS_ENV: test
      NODE_ENV: test
    bundler_env:
      env: dev
    outputs:
      - client
      - server

  # Production: Server only
  prod-server:
    description: Build server bundle for production
    environment:
      NODE_ENV: production
      RAILS_ENV: ${RAILS_ENV:-production} # Shell-style default values
    bundler_env:
      env: serverBundleProd
    outputs:
      - server

  # Production with instrumentation
  prod-instrumented:
    description: Build server with instrumentation
    environment:
      NODE_ENV: production
      RAILS_ENV: ${RAILS_ENV:-production}
    bundler_env:
      env: serverBundleProd
      instrumented: true # Translates to --env instrumented
      modernBrowsers: true # Translates to --env modernBrowsers
    outputs:
      - server
```

### Field Definitions

#### Top Level

- **`default_bundler`** (optional): `webpack` or `rspack` - default bundler for all builds
- **`builds`** (required): Object containing named build configurations

#### Build Configuration

- **`description`** (optional): Human-readable description of the build
- **`environment`** (optional): Object of shell environment variables (NODE_ENV, RAILS_ENV, NODE_OPTIONS, BABEL_ENV, etc.)
- **`bundler_env`** (optional): Object of bundler-specific `--env` arguments
  - Key-value pairs where:
    - String values: `env: dev` → `--env env=dev`
    - Boolean `true`: `instrumented: true` → `--env instrumented`
- **`outputs`** (optional): Array of output names (e.g., `[client, server]`)
  - Maps to config array indices
  - Used for file naming and metadata
  - If omitted, uses existing auto-detection logic
- **`config`** (optional): Config file path
  - Defaults to auto-detected `<bundler>.config.{ts,js}`
  - Supports `${BUNDLER}` substitution: `${BUNDLER}.config.ts`

### Environment Variable Expansion

The config file supports shell-style variable expansion:

- **`${VAR}`**: Expands to environment variable value
- **`${VAR:-default}`**: Expands to VAR or default if not set
- **`${BUNDLER}`**: Special variable replaced with active bundler (webpack/rspack)

Examples:

```yaml
environment:
  RAILS_ENV: ${RAILS_ENV:-production} # Falls back to "production"
config: ${BUNDLER}.config.ts # Becomes webpack.config.ts or rspack.config.ts
```

## New CLI Arguments

### Configuration File Arguments

- **`--init`**: Generate sample `.bundler-config.yml` with verbose comments and examples
- **`--config-file=<path>`**: Specify custom config file path (default: `.bundler-config.yml`)
- **`--build=<name>`**: Export config for specific build from YAML file
- **`--list-builds`**: List all available builds from YAML config file

### Bundler Selection (Simplified)

- **`--webpack`**: Use webpack (overrides config file and auto-detection)
- **`--rspack`**: Use rspack (overrides config file and auto-detection)
- **`--bundler=webpack|rspack`**: Alternative syntax (backward compatible)

### Bundler Resolution Order

1. CLI flag (`--webpack` or `--rspack` or `--bundler=`)
2. Build-specific bundler in YAML
3. `default_bundler` in YAML
4. Auto-detect from `config/shakapacker.yml`
5. Fall back to `webpack`

### Backward Compatibility

All existing CLI arguments continue to work without a config file:

- `--env=development|production|test`
- `--client-only`
- `--server-only`
- `--output=<filename>`
- `--save`, `--save-dir=<dir>`, `--doctor`
- `--format=yaml|json|inspect`
- `--annotate`, `--no-annotate`
- `--verbose`, `--depth=<number>`

## Output File Naming

When using `--save` or `--doctor` with build configurations:

**Pattern:** `<bundler>-<build-name>-<output>.yml`

Examples:

- `webpack-dev-client.yml`
- `webpack-dev-server.yml`
- `rspack-dev-client.yml`
- `rspack-dev-server.yml`
- `webpack-cypress-dev-client.yml`
- `webpack-prod-server-server.yml`

## Usage Examples

### Initialize Configuration File

```bash
# Generate sample config file with examples and comments
bin/export-bundler-config --init
```

### List Available Builds

```bash
# Show all builds defined in config file
bin/export-bundler-config --list-builds
```

Output:

```
Available builds in .bundler-config.yml:

  dev
    Description: Build admin and consumer bundles for dev env
    Bundler: webpack (default)
    Outputs: client, server

  dev-server
    Description: Build server bundle for dev env
    Bundler: webpack (default)
    Outputs: server

  cypress-dev
    Description: Build for Cypress development
    Bundler: webpack (default)
    Outputs: client, server

  prod-server
    Description: Build server bundle for production
    Bundler: webpack (default)
    Outputs: server
```

### Export Specific Build

```bash
# Export dev build using default bundler from config
bin/export-bundler-config --build=dev --save
# Creates: webpack-dev-client.yml, webpack-dev-server.yml

# Export dev build using rspack
bin/export-bundler-config --build=dev --save --rspack
# Creates: rspack-dev-client.yml, rspack-dev-server.yml

# Export cypress config to stdout (for inspection)
bin/export-bundler-config --build=cypress-dev

# Export only server config from dev build
bin/export-bundler-config --build=dev --server-only --save
# Creates: webpack-dev-server.yml
```

### Doctor Mode with Config File

```bash
# Export ALL builds defined in config file (dev + prod)
bin/export-bundler-config --doctor --config-file=.bundler-config.yml
# Creates files for every build and output combination

# Same but with rspack
bin/export-bundler-config --doctor --rspack
```

### Mixed Usage (CLI + Config)

```bash
# Use config file but override specific settings
bin/export-bundler-config --build=dev --save --format=json --rspack
```

## Command Translation Examples

### Example 1: Development Build

**YAML:**

```yaml
dev:
  environment:
    NODE_OPTIONS: "--max-old-space-size=4096"
    NODE_ENV: development
    RAILS_ENV: development
  bundler_env:
    env: dev
```

**Translates to (--webpack):**

```bash
NODE_OPTIONS="--max-old-space-size=4096" NODE_ENV=development RAILS_ENV=development webpack --env env=dev --config webpack.config.ts
```

**Translates to (--rspack):**

```bash
NODE_OPTIONS="--max-old-space-size=4096" NODE_ENV=development RAILS_ENV=development rspack --env env=dev --config rspack.config.ts
```

### Example 2: Production with Multiple Env Flags

**YAML:**

```yaml
prod-instrumented:
  environment:
    NODE_ENV: production
  bundler_env:
    env: serverBundleProd
    instrumented: true
    modernBrowsers: true
```

**Translates to:**

```bash
NODE_ENV=production webpack --env env=serverBundleProd --env instrumented --env modernBrowsers --config webpack.config.ts
```

### Example 3: Cypress Testing

**YAML:**

```yaml
cypress-dev:
  environment:
    NODE_OPTIONS: "--max-old-space-size=4096"
    BABEL_ENV: test
    RAILS_ENV: test
    NODE_ENV: test
  bundler_env:
    env: dev
  outputs:
    - client
    - server
```

**Translates to:**

```bash
NODE_OPTIONS="--max-old-space-size=4096" BABEL_ENV=test RAILS_ENV=test NODE_ENV=test webpack --env env=dev --config webpack.config.ts
```

## Implementation Tasks

### 1. Core Implementation

- [ ] Create `package/configExporter/configFile.ts` module

  - YAML config loading and parsing
  - Schema validation
  - Environment variable expansion
  - Build resolution logic

- [ ] Update `package/configExporter/types.ts`

  - Add config file schema types
  - Extend `ExportOptions` with new flags

- [ ] Update `package/configExporter/cli.ts`
  - Parse new CLI arguments (`--init`, `--build`, `--list-builds`, `--webpack`, `--rspack`, `--config-file`)
  - Integrate config file loading
  - Bundler resolution logic
  - Environment variable setup from config

### 2. New Commands

- [ ] Implement `--init` command

  - Generate `.bundler-config.yml` with comprehensive examples
  - Include verbose comments explaining each field
  - Include examples of common build scenarios

- [ ] Implement `--list-builds` command
  - Pretty-print all builds from config file
  - Show bundler, outputs, description

### 3. File Naming

- [ ] Update `fileWriter.ts` to support new naming pattern
  - `<bundler>-<build-name>-<output>.yml`
  - Handle build name in filename generation

### 4. Testing

- [ ] Add unit tests for config file parsing
- [ ] Add integration tests for build resolution
- [ ] Test environment variable expansion
- [ ] Test bundler override precedence
- [ ] Test backward compatibility

### 5. Documentation

- [ ] Update README with YAML config examples
- [ ] Add migration guide for existing users
- [ ] Update `--help` text
- [ ] Add troubleshooting section

## Backward Compatibility

✅ All existing CLI-only usage continues to work unchanged:

```bash
bin/export-bundler-config --doctor
bin/export-bundler-config --save --env=production
bin/export-bundler-config --bundler=rspack --client-only
```

✅ Config file is completely optional

✅ CLI arguments override config file settings

✅ Precedence order ensures predictable behavior:

1. Explicit CLI flags
2. Build-specific config
3. Default config
4. Auto-detection
5. Hard-coded defaults

## Benefits

### For Users

- ✅ Version-controlled build configurations
- ✅ Self-documenting build process
- ✅ Easy switching between webpack and rspack
- ✅ No need to remember complex environment variable combinations
- ✅ Quick troubleshooting with `--doctor --build=<name>`
- ✅ Reusable configurations across team members

### For Maintainers

- ✅ Easier to reproduce user build issues
- ✅ Better visibility into common build patterns
- ✅ Foundation for future enhancements (e.g., `--exec` to actually run builds)

### For CI/CD

- ✅ Consistent build commands across environments
- ✅ Easy to test configurations with both bundlers
- ✅ Simplified pipeline configuration

## Future Enhancements (Out of Scope)

These could be added in future iterations:

- `--exec=<build-name>`: Actually execute the build command (not just export config)
- Support for custom config file formats (JSON, TOML)
- Build inheritance/composition
- Validation mode to check if config file is valid
- Interactive mode for generating config files
